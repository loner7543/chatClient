<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="stylesheet" href="../css/chat.css">
<script type="text/javascript" src="../js/db.js"></script>


</head><body><dom-module id="chat-page">
	<template>
			<div class="container" id="container">		
				<template is="dom-if" if="{{isLoading}}">
					<div style="display:flex;flex-flow:column;align-items:center;">
						<div class="loading"></div>
					</div>
				</template>
				<template is="dom-repeat" items="{{mass}}" id="rep">
					<div class="txt">
						 <b style$="[[getColor(index)]]">{{item}}</b><span>   Yo!</span>
					</div>
				</template>					
			</div>
		<div class="add-button">
			<paper-fab style="color:whie;" id="add" label="Yo!"></paper-fab><br>
			<paper-button id="loadBtn">load many</paper-button>
		</div>
	</template>
	<script>
        window.addEventListener("WebComponentsReady", function(){
            console.log("ready");
		Polymer({
			is:"chat-page",
			properties:{
				user:{
					type:Object,
					value: {
							name:"",
							server:""
						}
				},
				last:{
					type:Number,
					value: +new Date()
				},

				mesCount:{
                    type:Number,
                    value: 3
				},
				mass:{
					type:Array,
					value: []
//					value(){
//						return [];
//					},
//					notify:true,
				},
				colorMap:{
					type:Object,
					value:[]
				},
				colors:{
					type:Array,
					value:["#f24949"]
				},
				isLoading:{
					type:Boolean,
					value:false
				}
			},
			listeners:{
				'add.tap':'sendMessage',				
				'container.track':'onTrack',
				'loadBtn.tap':'handleTap'
			},			
			ready:function(){
				var self = this;
				
			},
			onTrack:function(e){
                var self=this;
                var scrolled = this.$.container.scrollTop;
                var dy = e.detail.dy;
				if(scrolled === 0 && dy>0){
					self.debounce("load",self.loadItems,250);					
				}
			},
            handleTap: function(e) {
			    console.log(e);
                this.mesCount+=3;
			    this.loadItems();
                var div = this.$.rep;
                //var template = document.querySelector('container');
                div.render();
                //this.$..render();
                console.log("r");

            },
			beginDataLoad:function(e){
                var self = this;
				ws("ws://"+this.user.server+"/ws",function(mes){
				    if (mes.data!=""){
                        self.push("mass",mes.data)
					}//отерываем подключение
				});
				this.loadItems();							
			},
			loadItems:function(){
                var self = this;
				self.set("isLoading",true);
				makeRequest("http://"+this.user.server+"/api/msg?from="+this.last+"&count="+this.mesCount,function(data){//передали последнюю дату в запрос - вернутся все сообщения
					console.log("Данные из запроса"+data);
                    if (data!=""){
                        var mass  = data.split(';');
                        self.set('mass', mass.reverse());
                    }//отерываем подключение


					self.set("isLoading",false);
				},function(error){
					self.set("isLoading",false);
				});
			},
			sendMessage:function(){
			    send(this.user.name+' '+new Date().toLocaleString());
			},
			getDate:function(index){
				return (new Date(this.mass[index].stamp)).toLocaleString();
			},
			getName:function(index){
				return this.mass[index].name;
			},
			getColor:function(index){
                var name = this.getName(index);
				if(!this.colorMap[name]){
                    var idx = Math.floor(this.colors.length*Math.random());
                    var color ="color:"+this.colors[idx]+";";
					this.colorMap[name]=color;
				}
				return this.colorMap[name];			
			}
		});
        });
	</script>
</dom-module></body></html>