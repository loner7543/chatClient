<html><head><meta charset="UTF-8"><link rel="import" href="../main-app/main-app.html"></head><body><dom-module id="chat-page">
	<template>
		<style>
			.container{
				display: block;
				padding-top: 12px;
				height: calc(100% - 64px);
				max-height: calc(100% - 84px);
				overflow-y: auto;
				position: absolute;
				width: calc(100% - 18px);
			}
			.add-button{
				position:fixed;
				bottom:12px;
				right:12px;
			}		
			.txt{
				font-size: 1.3em;
				line-height: 1.3em;
				padding: 8px 4px 8px 4px;
				border-top: 1px solid rgba(0,0,0,0.3);
				text-shadow: 0px 0px 1px black;
			}
			@-webkit-keyframes spin {
			  0% {
				-webkit-transform: rotate(0deg);
						transform: rotate(0deg);
			  }
			  100% {
				-webkit-transform: rotate(360deg);
						transform: rotate(360deg);
			  }
			}
			@keyframes spin {
			  0% {
				-webkit-transform: rotate(0deg);
						transform: rotate(0deg);
			  }
			  100% {
				-webkit-transform: rotate(360deg);
						transform: rotate(360deg);
			  }
			}

			.loading {
				background: #3f51b5;
				border-radius: 50%;
				width: 24px;
				height: 24px;
				border: 0.25rem solid rgba(255, 255, 255, 0.2);
				border-top-color: rgba(255, 255, 255, 0.65);
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			.time{
				color: rgb(78, 78, 78);
				background: rgb(189, 199, 255);
				border-radius: 4px;
				padding: 2px 16px;
				font-weight: bolder;
				text-shadow: none;
			}
			
			
		</style>		
			<div class="container" id="container">		
				<template is="dom-if" if="{{isLoading}}">
					<div style="display:flex;flex-flow:column;align-items:center;">
						<div class="loading"></div>
					</div>
				</template>
				<template is="dom-repeat" items="{{items}}">
					<div class="txt">
						<span class="time">{{getDate(index)}}</span> <b style$="[[getColor(index)]]">{{getName(index)}}</b>:Yo!
					</div>
				</template>					
			</div>
		<div class="add-button">
			<paper-fab style="color:whie;" id="add" label="Yo!"></paper-fab>
		</div>
	</template>
	<script>
		Polymer({
			is:"chat-page",
			properties:{
				user:{
					type:Object,
					value(){
						return {
							name:"",
							server:""
						}
					}
				},
				last:{
					type:Number,
					value: +new Date()
				},
				items:{
					type:Array,
					value(){
						return [];
					},
					notify:true,
				},
				colorMap:{
					type:Object,
					value(){
						return {}
					}
				},
				colors:{
					type:Array,
					value()
					{
						return ["#ff4949","#5652c7","#2a9c2c","#21b7c3","#dbdd07","#f9971d","#9347d4","#d831b0","#8ccc32","#ce2626"];
					}
				},
				isLoading:{
					type:Boolean,
					value:false
				}
			},
			listeners:{
				'add.tap':'sendMessage',				
				'container.track':'onTrack'
			},			
			ready(){
				let self = this;
				/*this.$.container.onscroll=e=>{
					let scrolled = self.$.container.scrollTop;
					if(scrolled === 0){
						self.debounce("load",self.loadItems,250);
					}
				}*/
				
			},	
			onTrack(e){			
				let self=this;
				let scrolled = this.$.container.scrollTop;
				let dy = e.detail.dy;
				if(scrolled === 0 && dy>0){
					self.debounce("load",self.loadItems,250);					
				}
			},
			beginDataLoad(){
				let self = this;
				NetworkUtils.ws("ws://"+this.user.server+"/ws",mes=>{				
					self.push("items",JSON.parse(mes.data))					
				});
				this.loadItems();							
			},
			loadItems(){
				let self = this;
				self.set("isLoading",true);
				NetworkUtils.makeRequest("http://"+this.user.server+"/api/msg?from="+this.last,data=>{
					let newItems =JSON.parse(data);
					for(let i = 0; i<newItems.length;i++){
						self.unshift("items",newItems[i]);					
					}
					let msgs= self.items;
					if(msgs.length){
						this.last=msgs[0].stamp;
					}		
					self.set("isLoading",false);					
				},error=>{
					self.set("isLoading",false);
				});
			},
			sendMessage(){
				NetworkUtils.send(JSON.stringify({
					name:this.user.name,
					stamp:+(new Date())
				}));
			},
			getDate(index){				
				return (new Date(this.items[index].stamp)).toLocaleString();
			},
			getName(index){
				return this.items[index].name;
			},
			getColor(index){
				let name = this.getName(index);
				if(!this.colorMap[name]){
					let idx = Math.floor(this.colors.length*Math.random());
					let color ="color:"+this.colors[idx]+";";
					this.colorMap[name]=color;
				}
				return this.colorMap[name];			
			}
		});
	</script>
</dom-module></body></html>